<div class="upload-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 style="color: var(--pharmacy-secondary);">
      <i class="fas fa-edit me-2"></i>
      Edit Prescription
    </h2>
    <%= link_to prescriptions_path, class: 'btn btn-outline-secondary' do %>
      <i class="fas fa-arrow-left me-2"></i>Back to Report
    <% end %>
  </div>

  <%= form_with model: @prescription, local: true do |form| %>
    <% if @prescription.errors.any? %>
      <div class="alert alert-danger">
        <h5>Errors prevented this prescription from being saved:</h5>
        <ul class="mb-0">
          <% @prescription.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="prescription_patient_name" class="form-label fw-bold">
          <i class="fas fa-user me-2"></i>Patient Name
        </label>
        <%= text_field_tag 'prescription[patient_name]', @prescription.patient.name, class: 'form-control', placeholder: 'Enter patient name', required: true, list: 'patients-datalist' %>
        <datalist id="patients-datalist">
          <% @patients.each do |patient| %>
            <option value="<%= patient.name %>">
          <% end %>
        </datalist>
        <small class="text-muted">Type to select existing or create new patient</small>
      </div>

      <div class="col-md-6 mb-3">
        <%= form.label :drug_name, class: 'form-label fw-bold' do %>
          <i class="fas fa-pills me-2"></i>Drug Name
        <% end %>
        <div data-controller="drug-autocomplete">
          <%= form.text_field :drug_name, 
              class: 'form-control', 
              placeholder: 'Type to search drug names...', 
              required: true,
              data: { 
                drug_autocomplete_target: 'input',
                action: 'input->drug-autocomplete#search keydown->drug-autocomplete#navigate'
              } %>
          <div data-drug-autocomplete-target="results" class="autocomplete-results d-none"></div>
        </div>
        <small class="text-muted">Start typing to search RxNorm drug database</small>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        <%= form.label :created, class: 'form-label fw-bold' do %>
          <i class="fas fa-check-circle me-2"></i>Prescription Status
        <% end %>
        <div class="form-check form-switch" style="padding-top: 0.5rem;">
          <%= form.check_box :created, class: 'form-check-input', id: 'prescription_created' %>
          <%= form.label :created, 'Created', class: 'form-check-label' %>
        </div>
        <small class="text-muted">Mark as created prescription</small>
      </div>

      <div class="col-md-4 mb-3">
        <%= form.label :fill_count, class: 'form-label fw-bold' do %>
          <i class="fas fa-plus-square me-2"></i>Fill Count
        <% end %>
        <%= form.number_field :fill_count, class: 'form-control', min: 0 %>
      </div>

      <div class="col-md-4 mb-3">
        <%= form.label :return_count, class: 'form-label fw-bold' do %>
          <i class="fas fa-minus-square me-2"></i>Return Count
        <% end %>
        <%= form.number_field :return_count, class: 'form-control', min: 0 %>
      </div>
    </div>

    <div class="alert alert-info">
      <strong><i class="fas fa-calculator me-2"></i>Current Calculation:</strong>
      Net Fills: <%= @prescription.net_fills %> | Income: $<%= @prescription.income %>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <%= link_to 'Cancel', prescriptions_path, class: 'btn btn-secondary' %>
      <div class="d-flex gap-2">
        <%= form.submit 'Update Prescription', class: 'btn btn-pharmacy' %>
        <%= button_to 'Delete', prescription_path(@prescription), method: :delete, form: { class: 'd-inline' }, class: 'btn btn-danger', data: { turbo_confirm: 'Are you sure you want to delete this prescription?' } %>
      </div>
    </div>
  <% end %>
</div>
